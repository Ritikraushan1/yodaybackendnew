{% extends "admin/layout.njk" %}
{% set active = "posts" %}

{% block content %}
<h1 class="text-3xl font-bold mb-6">All Posts</h1>

<!-- âœ… Alert Message -->
<div id="alertBox" class="hidden mb-4 p-3 rounded-lg text-white text-sm font-medium"></div>

<!-- ðŸ” Search Form -->
<form method="get" action="/admin/posts" class="mb-6 flex items-center gap-2">
  <input 
    type="text" 
    name="search" 
    value="{{ query.search or '' }}" 
    placeholder="Search by content..." 
    class="border rounded-lg p-2 flex-1"
  >
  <button 
    type="submit" 
    class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-4 py-2 rounded-lg hover:opacity-90"
  >
    Search
  </button>
</form>

<div class="bg-white p-6 rounded-2xl shadow-lg overflow-x-auto">
  <table class="w-full text-left border-collapse">
    <thead>
      <tr class="border-b bg-gray-50">
        <th class="p-2">ID</th>
        <th class="p-2">Content</th>
        <th class="p-2">Author</th>
        <th class="p-2">Status</th>
        <th class="p-2">Likes</th>
        <th class="p-2">Dislikes</th>
        <th class="p-2">Posted At</th>
        <th class="p-2 text-center">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% if posts and posts.length %}
        {% for post in posts %}
        <tr id="post-{{ post.post_code }}" class="border-b hover:bg-gray-50 transition">
          <td class="p-2 font-mono text-sm">{{ post.post_code }}</td>
          <td class="p-2 truncate max-w-xs">{{ post.content }}</td>
          <td class="p-2">{{ post.posted_by }}</td>
          <td class="p-2">
            <span class="px-2 py-1 rounded-full text-xs 
              {% if post.status == 'active' %} bg-green-100 text-green-700 
              {% else %} bg-red-100 text-red-700 {% endif %}">
              {{ post.status }}
            </span>
          </td>
          <td class="p-2 text-center">{{ post.like_count or 0 }}</td>
          <td class="p-2 text-center">{{ post.dislike_count or 0 }}</td>
          <td class="p-2 text-sm text-gray-500">
            {% if post.created_at %}
              {{ post.created_at.toISOString().slice(0, 19).replace('T', ' ') }}
            {% else %}
              â€”
            {% endif %}
          </td>
          <td class="p-2 flex gap-2 justify-center">
            <!-- Comments Button -->
            <a href="/admin/posts/{{ post.post_code }}/comments" 
              class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-sm">
              Read Comments
            </a>
            
            <!-- Delete Button -->
            {% if post.status != 'deleted' %}
            <button
              class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-sm"
              onclick="deletePost('{{ post.post_code }}')"
            >
              Delete
            </button>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="8" class="p-4 text-center text-gray-500 italic">
            No posts found
          </td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>

<!-- âœ… JavaScript for Delete + Alerts -->
<script>
  async function deletePost(postCode) {
    if (!confirm('Are you sure you want to delete this post?')) return;

    try {
      const res = await fetch(`/admin/posts/${postCode}/delete`, {
        method: 'GET'
      });

      const data = await res.json();

      if (res.ok && data.message) {
        showAlert('âœ… ' + data.message, 'green');
        // Wait a bit, then refresh to show updated status
        setTimeout(() => {
          window.location.reload();
        }, 1200);
      } else {
        showAlert('âŒ Failed to delete post', 'red');
      }
    } catch (err) {
      console.error(err);
      showAlert('âš ï¸ Error deleting post', 'red');
    }
  }

  function showAlert(message, color = 'green') {
    const alertBox = document.getElementById('alertBox');
    alertBox.textContent = message;
    alertBox.className = `mb-4 p-3 rounded-lg text-white text-sm font-medium bg-${color}-600`;
    alertBox.classList.remove('hidden');
    setTimeout(() => {
      alertBox.classList.add('hidden');
    }, 2000);
  }
</script>
{% endblock %}
